<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico da Chave API | Gemini</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="../../../assets/style.css">
    <script src="../../../assets/layout.js"></script>

    <style>
        .diag-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        .status-card {
            background: white; border-radius: 15px; padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
            border-left: 5px solid #ccc;
        }
        .status-card.success { border-left-color: #00b894; }
        .status-card.error { border-left-color: #d63031; }

        .model-list {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .model-item {
            background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #eee;
            font-size: 0.9rem;
        }
        .model-name { font-weight: 800; color: #0984e3; margin-bottom: 5px; font-family: monospace; font-size: 1rem; }
        .model-detail { color: #636e72; font-size: 0.8rem; }

        .btn-check {
            background: #2d3436; color: white; border: none; padding: 12px 25px;
            border-radius: 30px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px;
            margin-bottom: 20px; transition: 0.2s;
        }
        .btn-check:hover { transform: scale(1.02); background: #000; }

        pre { background: #2d3436; color: #55efc4; padding: 15px; border-radius: 10px; overflow-x: auto; }
    </style>
</head>
<body>

    <script>
        carregarHeader("Diagnóstico de API", "Verifique o acesso da sua Chave Google");
    </script>

    <div class="diag-container">
        
        <div class="status-card" id="keyStatusCard">
            <h3 style="margin-top:0;">1. Chave API Armazenada</h3>
            <p id="keyStatusText">Verificando...</p>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-check" onclick="editKey()" style="background:#0984e3; font-size:0.8rem;">
                    <i class="fa-solid fa-pen"></i> Editar Chave
                </button>
                <button class="btn-check" onclick="checkModels()">
                    <i class="fa-solid fa-stethoscope"></i> Testar Conexão e Listar Modelos
                </button>
            </div>
        </div>

        <div id="resultsArea" style="display:none;">
            <h3 style="color:#2d3436;">2. Modelos Disponíveis para Você</h3>
            <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">
                Abaixo estão os modelos que o Google confirmou que sua chave pode usar.
                Use os nomes em <strong>azul</strong> nos seus códigos.
            </p>
            <div class="model-list" id="modelList"></div>
            
            <h3 style="color:#2d3436; margin-top:30px;">3. Log Bruto (JSON)</h3>
            <pre id="rawLog">Aguardando teste...</pre>
        </div>

    </div>

    <script>
        // 1. VERIFICA CHAVE LOCAL
        function checkLocalKey() {
            const key = localStorage.getItem('gemini_api_key');
            const card = document.getElementById('keyStatusCard');
            const text = document.getElementById('keyStatusText');

            if (key) {
                card.className = "status-card success";
                const hiddenKey = key.substr(0, 4) + "..." + key.substr(key.length - 4);
                text.innerHTML = `✅ Chave encontrada no navegador: <strong>${hiddenKey}</strong>`;
                return key;
            } else {
                card.className = "status-card error";
                text.innerHTML = `❌ Nenhuma chave encontrada. Clique em "Editar Chave" para configurar.`;
                return null;
            }
        }

        function editKey() {
            const current = localStorage.getItem('gemini_api_key') || "";
            const newKey = prompt("Cole sua API Key do Google AI Studio:", current);
            if (newKey) {
                localStorage.setItem('gemini_api_key', newKey.trim());
                checkLocalKey();
            }
        }

        // 2. CONSULTA A API (ListModels)
        async function checkModels() {
            const apiKey = checkLocalKey();
            if (!apiKey) { alert("Configure a chave primeiro."); return; }

            const resultsArea = document.getElementById('resultsArea');
            const modelList = document.getElementById('modelList');
            const rawLog = document.getElementById('rawLog');
            
            resultsArea.style.display = 'block';
            modelList.innerHTML = '<p>Carregando...</p>';
            rawLog.innerText = 'Conectando ao Google...';

            try {
                // Endpoint oficial para listar modelos
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(JSON.stringify(data.error, null, 2));
                }

                // SUCESSO
                modelList.innerHTML = '';
                rawLog.innerText = JSON.stringify(data, null, 2); // Mostra o JSON cru para debug

                // Filtra apenas modelos que geram conteúdo (chat/texto)
                const chatModels = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));

                chatModels.forEach(model => {
                    // Limpa o "models/" do nome para facilitar a leitura
                    const cleanName = model.name.replace('models/', '');
                    
                    modelList.innerHTML += `
                        <div class="model-item">
                            <div class="model-name">${cleanName}</div>
                            <div class="model-detail">Versão: ${model.version}</div>
                            <div class="model-detail">Limite Entrada: ${model.inputTokenLimit} tokens</div>
                            <div class="model-detail">Limite Saída: ${model.outputTokenLimit} tokens</div>
                        </div>
                    `;
                });

                if (chatModels.length === 0) {
                    modelList.innerHTML = '<p style="color:red">Sua chave é válida, mas não tem acesso a modelos de chat. Verifique no Google AI Studio.</p>';
                }

            } catch (error) {
                console.error(error);
                modelList.innerHTML = `<p style="color:red; grid-column: 1/-1;"><strong>Erro Fatal:</strong> ${error.message}</p>`;
                rawLog.innerText = error.toString();
            }
        }

        // Inicializa
        checkLocalKey();
        carregarFooter();
    </script>

</body>
</html>
